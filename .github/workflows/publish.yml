name: Publish NuGet Packages

on:
  pull_request:
    branches: [main]
    types: [closed]
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version to publish (e.g. 1.2.65)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  publish:
    name: Pack & Publish
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 10.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install wasm-tools workload
        run: dotnet workload install wasm-tools

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "value=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=1.2.${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build Release
        run: dotnet build --configuration Release /p:Version=${{ steps.version.outputs.value }}

      - name: Pack all packages
        run: |
          set -euo pipefail
          mkdir -p artifacts/nuget
          for project in Sharc.Query Sharc.Core Sharc.Crypto Sharc.Graph.Surface \
                         Sharc Sharc.Graph Sharc.Vector Sharc.Arc; do
            echo "Packing ${project}..."
            dotnet pack "src/${project}/${project}.csproj" \
              --configuration Release --no-build \
              -o artifacts/nuget \
              /p:Version=${{ steps.version.outputs.value }}
          done

      - name: Verify package artifacts
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.value }}"
          for pkg in Sharc.Query Sharc.Core Sharc.Crypto Sharc.Graph.Surface \
                     Sharc Sharc.Graph Sharc.Vector Sharc.Arc; do
            [[ -f "artifacts/nuget/${pkg}.${VERSION}.nupkg" ]] \
              || { echo "::error::Missing ${pkg}.${VERSION}.nupkg"; exit 1; }
          done
          echo "All 8 packages verified."

      - name: Push all packages to NuGet
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          set -euo pipefail
          for nupkg in artifacts/nuget/*.nupkg; do
            echo "Pushing $(basename "$nupkg")..."
            dotnet nuget push "$nupkg" \
              --api-key "$NUGET_API_KEY" \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate
          done
