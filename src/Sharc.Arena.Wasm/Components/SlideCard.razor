@* A single benchmark slide card *@

@{
    var cat = Categories?.FirstOrDefault(c => c.Id == Slide.CategoryId);
    var activeTier = Slide.DensityTiers.FirstOrDefault(t => t.Id == TileDensity);

    // Find winner and max
    string? winnerId = null;
    double winVal = double.MaxValue;
    double maxVal = 0;
    if (Data is not null && Engines is not null)
    {
        foreach (var e in Engines)
        {
            if (Data.TryGetValue(e.Id, out var r) && !r.NotSupported && r.Value.HasValue)
            {
                if (r.Value.Value < winVal) { winVal = r.Value.Value; winnerId = e.Id; }
                if (r.Value.Value > maxVal) maxVal = r.Value.Value;
            }
        }
    }
    var cols = IsMobile ? 2 : (Engines?.Count ?? 3);
}

<div class="slide-card @(IsActive ? "active" : "") @(IsDone ? "done" : "") @(!IsDone && !IsActive ? "pending" : "")">
    <div class="slide-accent @(IsActive ? "active" : IsDone ? "done" : "")"></div>

    @* Header row *@
    <div class="slide-header">
        <div class="slide-header-left">
            <span class="slide-icon @(IsMobile ? "mobile" : "")">@Slide.Icon</span>
            <div>
                <div class="slide-meta">
                    <span class="slide-category" style="color: @cat?.Color; background: @(cat?.Color)12">@cat?.Label</span>
                    <span class="slide-number">@Number/@Total</span>
                    @if (activeTier is not null && activeTier.Rows > 0)
                    {
                        <span class="slide-density-label">&middot; @DensityLabel(activeTier)</span>
                    }
                </div>
                <h3 class="slide-title">@Slide.Title</h3>
                <p class="slide-subtitle">@Slide.Subtitle</p>
            </div>
        </div>
        <div class="slide-header-right">
            <DensityControl
                Tiers="@Slide.DensityTiers"
                ActiveTier="@TileDensity"
                OnChange="@OnDensityChange"
                Disabled="@Running" />
            @if (IsActive && !IsDone)
            {
                <div class="live-indicator">
                    <span class="blink-dot red"></span>
                    <span class="live-text">LIVE</span>
                </div>
            }
        </div>
    </div>

    @* Results grid *@
    @if ((IsDone || IsActive) && Data is not null)
    {
        <div class="slide-results" style="grid-template-columns: repeat(@cols, 1fr)">
            @foreach (var eng in Engines!)
            {
                Data.TryGetValue(eng.Id, out var r);
                <EngineResult
                    Engine="@eng"
                    Result="@r"
                    Unit="@Slide.Unit"
                    IsWinner="@(winnerId == eng.Id && IsDone)"
                    MaxValue="@maxVal"
                    WinnerValue="@(winnerId is not null ? winVal : null)"
                    Animate="@IsDone" />
            }
        </div>
    }

    @* Methodology *@
    @if (IsDone)
    {
        <div class="slide-methodology">
            <strong>Method: </strong>@Slide.Methodology
        </div>
        <WhyItMattersTooltip Text="@Slide.WhyItMatters" />
    }
</div>

@code {
    [Parameter] public required SlideDefinition Slide { get; set; }
    [Parameter] public IReadOnlyDictionary<string, EngineBaseResult>? Data { get; set; }
    [Parameter] public bool IsActive { get; set; }
    [Parameter] public bool IsDone { get; set; }
    [Parameter] public int Number { get; set; }
    [Parameter] public int Total { get; set; }
    [Parameter] public bool IsMobile { get; set; }
    [Parameter] public required string TileDensity { get; set; }
    [Parameter] public required EventCallback<string> OnDensityChange { get; set; }
    [Parameter] public bool Running { get; set; }
    [Parameter] public IReadOnlyList<EngineDefinition>? Engines { get; set; }
    [Parameter] public IReadOnlyList<Category>? Categories { get; set; }

    private static string DensityLabel(DensityTier tier)
    {
        if (tier.Rows == 0) return "";
        if (tier.Rows >= 1000) return $"{tier.Rows / 1000}K rows";
        return $"{tier.Rows} rows";
    }
}
