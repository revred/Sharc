# Sharc Code Review — February 12, 2026

Comprehensive code review of the Sharc codebase at Milestone 10 (Benchmarks COMPLETE).
447 tests passing (393 unit + 54 integration). 0 warnings, 0 errors.

---

## Critical — Must Fix Before v1.0

### 1. `SharcOpenOptions.FileShareMode` Declared But Never Used
- **File**: `src/Sharc/SharcOpenOptions.cs:46`
- **Issue**: `FileShareMode` property exists but `SharcDatabase.Open()` never passes it to `FilePageSource`. The `FilePageSource` constructor hardcodes `FileShare.ReadWrite` at line 70.
- **Impact**: Users cannot control file sharing behavior despite the option existing.
- **Fix**: Either pass `options.FileShareMode` through to `FilePageSource(path, shareMode)` or remove the property until it's wired.

### 2. `FilePageSource` Not Thread-Safe for Concurrent GetPage
- **File**: `src/Sharc.Core/IO/FilePageSource.cs:47`
- **Issue**: `_pageBuffer` is a single reusable buffer. If two threads call `GetPage()` simultaneously (unlikely today since `CachedPageSource` serializes via lock), the buffer would be corrupted. The file handle (`RandomAccess.Read`) is thread-safe, but the shared buffer is not.
- **Impact**: Currently mitigated by `CachedPageSource` lock, but fragile if cache is bypassed.
- **Fix**: Either document that `FilePageSource` is not thread-safe, or use `[ThreadStatic]` / per-call buffer.

---

## Important — Should Fix

### 3. Microsoft.Data.Sqlite Version Inconsistency
- **Files**: `tests/Sharc.IntegrationTests/Sharc.IntegrationTests.csproj` (9.0.2) vs `bench/Sharc.Benchmarks/Sharc.Benchmarks.csproj` (9.0.4)
- **Fix**: Align to same version. Consider centralizing in `Directory.Build.props` or `Directory.Packages.props`.

### 4. `BTreeCursor` Allocates HashSet Per Overflow Cell
- **File**: `src/Sharc.Core/BTree/BTreeCursor.cs:237`
- **Issue**: `new HashSet<uint>()` allocated every time `AssembleOverflowPayload` is called. For tables with many overflow records (e.g., large BLOBs), this creates GC pressure.
- **Fix**: Make `_visitedOverflowPages` a field, clear it between calls.

### 5. Graph Project Build Artifact Leftovers
- **Directories**: `src/Sharc.Graph/obj/`, `src/Sharc.Graph.Abstractions/obj/`
- **Issue**: Build artifacts from the GraphSupport branch remain in the working tree. No source files or csproj exist — just auto-generated obj files.
- **Fix**: Delete these directories or ensure `.gitignore` covers them (already covered by `obj/` rule). If Graph work is continuing on another branch, leave them.

### 6. `ProductContext/` Path References in PRC Docs
- **Files**: `PRC/DependencyPolicy.md:88`, `PRC/DecisionLog.md:251`, `PRC/SecurityModel.md:178`
- **Issue**: Three documents reference `ProductContext/` which was renamed to `PRC/`.
- **Fix**: Update internal cross-references to `PRC/`.

### 7. Sharc.Crypto Has No Source Files
- **Directory**: `src/Sharc.Crypto/`
- **Issue**: The project exists and builds, but contains no `.cs` source files. It's a placeholder for the Milestone 9 encryption work.
- **Fix**: Either add a `README.md` noting it's a placeholder, or remove the project until encryption work begins. Currently it adds to build time unnecessarily.

---

## Minor — Nice to Have

### 8. `ColumnValue.AsString()` Allocates Every Call
- **File**: `src/Sharc.Core/IRecordDecoder.cs:112`
- **Issue**: `Encoding.UTF8.GetString(_blobValue.Span)` creates a new string each invocation. Not a bug — expected for a struct — but repeated calls on the same value allocate redundantly.
- **Future**: Consider a `string?` cache field if benchmarks show repeated access patterns.

### 9. `SharcException` Missing Parameterless Constructor
- **File**: `src/Sharc.Core/Exceptions/SharcExceptions.cs:23`
- **Issue**: `SharcException` has no parameterless or serialization constructors. Modern .NET doesn't require `ISerializable`, but parameterless constructor is conventional for exception hierarchies.
- **Fix**: Add `public SharcException() : base("An error occurred in Sharc.") { }` if desired.

### 10. Schema Reading Uses Allocating DecodeRecord Overload
- **File**: `src/Sharc.Core/Schema/SchemaReader.cs:51`
- **Issue**: `_recordDecoder.DecodeRecord(cursor.Payload)` allocates a new `ColumnValue[]` per schema row. Since schema reading happens once at open time (typically <20 rows), this is acceptable.
- **Future**: Could use buffer-reuse overload if databases with thousands of tables are a concern.

### 11. No Central Package Version Management
- **Issue**: Package versions are scattered across individual csproj files. `Directory.Build.props` was added for build settings but NuGet versions aren't centralized.
- **Fix**: Consider adding `Directory.Packages.props` with `<ManagePackageVersionsCentrally>true</ManagePackageVersionsCentrally>` for version pinning.

---

## Completed in This Session

- [x] Created `Directory.Build.props` — centralizes TargetFramework, Nullable, ImplicitUsings, TreatWarningsAsErrors, versioning, NuGet metadata
- [x] Created `.editorconfig` — code style rules, CA1720 suppression (domain enum names), CA1707 suppression (test naming convention)
- [x] Simplified all 6 `.csproj` files — removed duplicated settings now handled by Directory.Build.props
- [x] Added `InternalsVisibleTo` for `Sharc.IntegrationTests` in both Sharc and Sharc.Core projects
- [x] Build: 0 warnings, 0 errors
- [x] Tests: 447 passed (393 unit + 54 integration)

---

## Architecture Health Summary

| Aspect | Status | Notes |
|--------|--------|-------|
| Zero TODOs/HACKs/FIXMEs | CLEAN | No technical debt markers in source |
| Zero NotImplementedException | CLEAN | All stubs are wired to real implementations |
| Zero skipped tests | CLEAN | All 447 tests active and passing |
| Sealed classes | CLEAN | All non-base classes are sealed |
| XML doc coverage | CLEAN | All public API members documented |
| Nullable annotations | CLEAN | `<Nullable>enable</Nullable>` everywhere |
| Exception hierarchy | CLEAN | 4 specific exception types, proper base class |
| Thread safety | VERIFIED | 12 concurrency tests, up to 16 threads |
| Performance | OPTIMIZED | stackalloc, buffer reuse, projection-aware decode |
