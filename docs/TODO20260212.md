# Sharc Execution Plan — February 12, 2026

Based on GreyPaper strategic priorities. Tasks chunked into ~10-minute blocks.
579 tests passing at session start. 604 tests passing after B+A streams. 660 tests passing after C+D+E(scaffold) streams. 696 tests passing after F+G streams.

---

## Status Key

- `[ ]` Not started
- `[~]` In progress
- `[x]` Complete
- `[—]` Deferred / blocked

---

## Stream A: NuGet Package Polish (30 min)

Goal: Make `dotnet pack` produce a publish-ready .nupkg.

- [x] A1: Add PackageReadmeFile, RepositoryUrl, PackageTags to Directory.Build.props
- [x] A2: Include README.md in NuGet packages via Directory.Build.props ItemGroup
- [x] A3: Run `dotnet pack`, verify .nupkg output — Sharc.1.0.0.nupkg (50KB, README included)

---

## Stream B: Page-Level Encryption — AES-256-GCM (90 min)

Goal: Read Sharc-encrypted databases per EncryptionSpec.md. Spec is complete, IPageTransform interface exists, SharcEncryptionOptions/enums defined.

- [x] B1: Create SharcKeyHandle — pinned key memory, IDisposable, zero-on-dispose (PBKDF2-SHA512 bridge, Argon2id v0.2)
- [x] B2: Create EncryptionHeader parser (128-byte Sharc header: magic, KDF params, salt, verification hash)
- [x] B3: Write EncryptionHeader tests (7 tests: valid parse, invalid magic, short buffer, round-trip)
- [x] B4: Create AesGcmPageTransform implementing IPageTransform (AES-256-GCM with deterministic HMAC nonce)
- [x] B5: Write AesGcmPageTransform tests (7 tests: round-trip, wrong key, tampered, wrong page, size)
- [x] B6: Create DecryptingPageSource wrapping IPageSource + IPageTransform
- [x] B7: Write DecryptingPageSource tests (6 tests: decrypt, ReadPage, size, count, dispose, ObjectDisposed)
- [x] B8: Wire encryption into SharcDatabase.Open — detect magic, derive key, verify HMAC, wrap page source
- [x] B9: Write encryption integration tests (5 tests: read data, wrong pw, no pw, IsEncrypted, multi-table)

---

## Stream C: Simple WHERE Filtering (60 min)

Goal: Filter rows during table scan without full SQL parser. Covers 80% of practical queries (GreyPaper section 4.3 P1).

- [x] C1: Define filter model — SharcFilter sealed record + SharcOperator enum (6 operators)
- [x] C2: Add CreateReader(tableName, SharcFilter[]) and CreateReader(tableName, columns, filters) overloads
- [x] C3: Implement FilterEvaluator with row-level evaluation in SharcDataReader.Read() loop
- [x] C4: Write 21 unit tests for filter evaluation (all operators, all types, null handling, cross-type coercion)
- [x] C5: Write 8 integration tests (filter on int, text, real; multi-filter AND; projection+filter; invalid column)
- [—] C6: Optimize — index-assisted equality filters (deferred, scan-based filtering is sufficient for v1)

---

## Stream D: WITHOUT ROWID Table Support (40 min)

Goal: Remove UnsupportedFeatureException for WITHOUT ROWID tables (GreyPaper section 4.3 P2).

- [x] D1: Research WITHOUT ROWID B-tree format — index B-tree, existing IndexBTreeCursor sufficient
- [x] D2: Create WithoutRowIdCursorAdapter wrapping IIndexBTreeCursor as IBTreeCursor, wire into SharcDatabase
- [x] D3: Fix CreateTableParser IsPrimaryKey for non-INTEGER PKs; write 7 unit tests for adapter
- [x] D4: Write 8 integration tests (TEXT PK, INTEGER PK, composite PK, projection, empty, filter, schema flag)

---

## Stream E (Scaffold): Row-Level Entitlement Crypto (GreyPaper Section 5)

Goal: Scaffold HKDF-SHA256 key derivation and entitlement context API. Full wiring deferred (5-7 weeks).

- [x] E1: Create HkdfSha256 — HKDF-SHA256 via System.Security.Cryptography.HKDF, DeriveRowKey()
- [x] E2: Create SharcEntitlementContext — HashSet-backed tag lookup, HasEntitlement(), IsEmpty
- [x] E3: Write 7 HKDF unit tests (determinism, different tags/keys, Unicode, byte/string parity)
- [x] E4: Write 6 SharcEntitlementContext unit tests (store, lookup, empty, dedup)
- [ ] E5: Wire entitlement into SharcOpenOptions (deferred)
- [ ] E6: Extend RecordDecoder with 0x01 flag detection + inline AES-GCM decrypt (deferred)
- [ ] E7: Build _sharc_entitlements table schema + multi-tenant integration tests (deferred)

---

## Stream F: Rename + MCP Context Query Tools (40 min)

Goal: Rename Sharc.McpServer → Sharc.Context. Add database query tools so AI agents can query .db files directly.

- [x] F1: Rename Sharc.McpServer → Sharc.Context (folder, csproj, namespaces, sln, settings)
- [x] F2: Add ListSchema tool — opens .db, returns tables/columns as markdown
- [x] F3: Add GetRowCount tool — opens .db, returns row count per table
- [x] F4: Add QueryTable tool — opens .db, scans table, returns markdown (cap 100 rows, projection, filter)
- [x] F5: Add SeekRow tool — opens .db, seeks by rowid, returns single row
- [x] F6: Write 14 ContextQueryTool tests (schema, count, query, seek, error handling)

---

## Stream G: sharc-index CLI Scaffold (60 min)

Goal: Create the CLI project skeleton that builds a GitHub Context Database. Uses Microsoft.Data.Sqlite for writes, Sharc for reads. (GreyPaper section 3.1)

- [x] G1: Create tools/Sharc.Index project (console app, add to solution)
- [x] G2: Define GCD schema — commits, files, file_changes tables (GcdSchemaBuilder, 7 tests)
- [x] G3: Implement git log walker — parse commit lines and diff --numstat (GitLogWalker, 8 tests)
- [x] G4: Implement commit-to-SQLite writer — batch INSERT with upserts (CommitWriter, 7 tests)
- [x] G5: Wire CLI entry point (--repo, --output, --since, --help)

---

## Priority Order (what to build first)

1. **B: Encryption** — P0, enterprise gate, spec complete, highest GreyPaper impact
2. **A: NuGet** — quick win, enables adoption immediately
3. **C: WHERE filtering** — P1, unlocks 80% query patterns
4. **E: MCP tools** — enables AI agent integration (GreyPaper critical path)
5. **D: WITHOUT ROWID** — P2 completeness
6. **F: sharc-index** — largest effort, scaffolding only today

---

## Prior Code Review Items (from previous session)

All critical items resolved on webAssembly branch:

- [x] FileShareMode wired through to FilePageSource
- [x] FilePageSource thread safety (ThreadStatic buffer)
- [x] Microsoft.Data.Sqlite version centralized (Directory.Packages.props)
- [x] Central package management (Directory.Packages.props)
- [x] Sharc.Crypto placeholder added
- [x] Index B-tree reads (M7 complete)
- [x] WAL read support (M8 complete)
- [x] 0 warnings achieved
